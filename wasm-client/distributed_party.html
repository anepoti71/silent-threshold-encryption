<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Party Client - Silent Threshold Encryption</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .log-entry.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .info-box {
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
        }

        .warning-box {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Distributed Party Client</h1>
        <p class="subtitle">Browser-Based Threshold Encryption with TLS (WebSocket Secure)</p>

        <div class="card">
            <h2>üì° Connection Settings</h2>
            <div class="form-group">
                <label for="partyId">Party ID (0-3):</label>
                <input type="number" id="partyId" value="0" min="0" max="3">
                <small style="display: block; margin-top: 5px; color: #666;">
                    Party 0 is the dummy party (nullified secret key)
                </small>
            </div>
            <div class="form-group">
                <label for="wsUrl">WebSocket URL:</label>
                <input type="text" id="wsUrl" value="wss://localhost:8080" placeholder="wss://localhost:8080">
                <small style="display: block; margin-top: 5px; color: #666;">
                    <strong>TLS Encryption:</strong> Use <code>wss://</code> for secure connections (TLS 1.3)<br>
                    <strong>Plain Text:</strong> Use <code>ws://</code> for unencrypted connections (not recommended)
                </small>
            </div>
            <button id="connectBtn" onclick="connectToCoordinator()">üîå Connect to Coordinator</button>
            <button id="disconnectBtn" onclick="disconnectFromCoordinator()" disabled class="danger">‚ùå Disconnect</button>
            <div id="connectionStatus" class="status info" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>üìù Activity Log</h2>
            <div id="activityLog" class="log">
                <div class="log-entry">Waiting for connection...</div>
            </div>
        </div>

        <div class="card">
            <h2>‚ÑπÔ∏è How It Works</h2>
            <div class="info-box">
                <h3 style="margin-bottom: 10px;">Protocol Flow:</h3>
                <ol style="margin-left: 20px; line-height: 2;">
                    <li><strong>Connect:</strong> Establish WebSocket connection to coordinator</li>
                    <li><strong>Key Generation:</strong> Generate secret/public key pair when requested</li>
                    <li><strong>Partial Decryption:</strong> Compute partial decryption when requested</li>
                    <li><strong>Protocol Complete:</strong> Receive success confirmation</li>
                </ol>
            </div>

            <div class="warning-box">
                <strong>üîí TLS Security:</strong><br>
                When using <code>wss://</code> (WebSocket Secure), all communication is encrypted with TLS 1.3,
                protecting your secret key and cryptographic material during transmission. This is equivalent to HTTPS
                and provides the same level of security as the Rust TCP+TLS implementation.
            </div>

            <div class="info-box" style="margin-top: 15px;">
                <strong>üìä Technical Details:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>Curve: BLS12-381</li>
                    <li>Protocol: Silent Threshold Encryption</li>
                    <li>Transport: WebSocket (ws:// or wss://)</li>
                    <li>Message Format: JSON</li>
                    <li>Serialization: Compressed Arkworks format</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { DistributedParty } from './pkg/silent_threshold_encryption_wasm.js';

        let party = null;
        let isConnected = false;

        await init();
        addLog('‚úì WASM module loaded successfully', 'success');

        window.connectToCoordinator = function() {
            const partyId = parseInt(document.getElementById('partyId').value);
            const wsUrl = document.getElementById('wsUrl').value;

            // Validate WebSocket URL
            if (!wsUrl.startsWith('ws://') && !wsUrl.startsWith('wss://')) {
                addLog('‚ùå Invalid WebSocket URL. Must start with ws:// or wss://', 'error');
                return;
            }

            if (wsUrl.startsWith('wss://')) {
                addLog('üîí Using encrypted connection (TLS 1.3)', 'success');
            } else {
                addLog('‚ö†Ô∏è Using unencrypted connection', 'error');
            }

            addLog(`Creating party with ID ${partyId}...`);

            try {
                party = new DistributedParty(partyId);

                // Set up status callback
                party.onStatus((status) => {
                    addLog(status);
                });

                // Set up message callback
                party.onMessage((messageType, dataJson) => {
                    const data = JSON.parse(dataJson);
                    handleCoordinatorMessage(messageType, data);
                });

                addLog(`Connecting to ${wsUrl}...`);
                party.connect(wsUrl);

                // Send ready message after a short delay
                setTimeout(() => {
                    if (party) {
                        party.sendReady();
                        addLog('‚úì Sent ready message to coordinator', 'success');
                    }
                }, 1000);

                isConnected = true;
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                updateConnectionStatus('Connecting...', 'info');

            } catch (error) {
                addLog(`‚ùå Error: ${error}`, 'error');
                updateConnectionStatus(`Connection failed: ${error}`, 'error');
            }
        };

        window.disconnectFromCoordinator = function() {
            if (party) {
                party.disconnect();
                addLog('Disconnected from coordinator');
                isConnected = false;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                updateConnectionStatus('Disconnected', 'info');
                party = null;
            }
        };

        function handleCoordinatorMessage(messageType, data) {
            addLog(`üì® Received ${messageType} from coordinator`);

            try {
                switch (messageType) {
                    case 'RequestPublicKey':
                        addLog('üîë Handling public key request...');
                        const tauBytes = new Uint8Array(data.tau_bytes);
                        const n = data.n;
                        party.handlePublicKeyRequest(tauBytes, n);
                        updateConnectionStatus('Generated and sent public key', 'success');
                        break;

                    case 'RequestPartialDecryption':
                        addLog('üîì Handling partial decryption request...');
                        const ctBytes = new Uint8Array(data.ct_bytes);
                        party.handlePartialDecryptionRequest(ctBytes);
                        updateConnectionStatus('Computed and sent partial decryption', 'success');
                        break;

                    case 'Success':
                        addLog(`‚úÖ ${data.message}`, 'success');
                        updateConnectionStatus(data.message, 'success');
                        break;

                    case 'Error':
                        addLog(`‚ùå ${data.message}`, 'error');
                        updateConnectionStatus(data.message, 'error');
                        break;

                    case 'Ciphertext':
                        addLog('üì¶ Received ciphertext from coordinator');
                        updateConnectionStatus('Received ciphertext', 'info');
                        break;

                    default:
                        addLog(`‚ö†Ô∏è Unknown message type: ${messageType}`);
                }
            } catch (error) {
                addLog(`‚ùå Error handling message: ${error}`, 'error');
                updateConnectionStatus(`Error: ${error}`, 'error');
            }
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        addLog('Ready to connect to coordinator');
        addLog('üí° Tip: Use wss:// for TLS-encrypted connections');
    </script>
</body>
</html>
