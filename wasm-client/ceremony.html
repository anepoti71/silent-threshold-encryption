<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trusted Setup Ceremony - Browser-Based</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .warning {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-title {
            color: #c53030;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .phase {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .phase h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        button:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        button.danger {
            background: #f56565;
        }

        button.danger:hover:not(:disabled) {
            background: #e53e3e;
        }

        button.success {
            background: #48bb78;
        }

        button.success:hover:not(:disabled) {
            background: #38a169;
        }

        input, textarea {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1em;
            width: 100%;
            font-family: inherit;
        }

        textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            min-height: 100px;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .log {
            background: #1a202c;
            color: #48bb78;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #48bb78;
            padding-left: 10px;
        }

        .log-error {
            color: #f56565;
            border-left-color: #f56565;
        }

        .log-success {
            color: #48bb78;
            border-left-color: #48bb78;
        }

        .log-info {
            color: #4299e1;
            border-left-color: #4299e1;
        }

        .log-warning {
            color: #ed8936;
            border-left-color: #ed8936;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #2d3748;
            font-size: 1.8em;
            font-weight: 600;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px 24px;
            background: #4a5568;
            color: white;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #2d3748;
        }

        .participant-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Trusted Setup Ceremony</h1>
        <p class="subtitle">Multi-Party Powers of Tau - Browser Edition</p>

        <div class="info">
            <strong>About This Ceremony:</strong><br>
            This ceremony allows multiple participants to contribute randomness to generate
            trusted setup parameters. As long as ONE participant is honest and destroys their
            secret, the final parameters are secure. This is called a "1-of-N" trust model.
        </div>

        <div class="warning">
            <div class="warning-title">‚ö†Ô∏è Security Requirements</div>
            After contributing, you MUST:
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>Close this browser tab completely</li>
                <li>Clear browser cache and history</li>
                <li>Restart your browser (recommended)</li>
                <li>Never reuse this device/browser for the ceremony</li>
            </ul>
        </div>

        <!-- Coordinator View -->
        <div class="phase" id="coordinatorPhase">
            <h2>üëë Coordinator: Start New Ceremony</h2>
            <div class="input-group">
                <label for="maxDegree">Maximum Degree (determines parameter size):</label>
                <input type="number" id="maxDegree" value="16" min="2">
                <small style="color: #718096;">Recommended: 16 for n‚â§16 parties, 32 for n‚â§32 parties</small>
            </div>
            <div class="controls">
                <button onclick="startCeremony()">Start New Ceremony</button>
                <button onclick="loadCeremony()">Load Existing Ceremony</button>
            </div>
        </div>

        <!-- Participant View -->
        <div class="phase" id="participantPhase" style="display: none;">
            <h2>üë• Participant: Contribute to Ceremony</h2>

            <div class="stats" id="ceremonyStats">
                <div class="stat-card">
                    <div class="stat-label">Participants</div>
                    <div class="stat-value" id="numParticipants">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Degree</div>
                    <div class="stat-value" id="statMaxDegree">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">State Size</div>
                    <div class="stat-value" id="stateSize">-</div>
                </div>
            </div>

            <div class="controls">
                <button onclick="addContribution()" class="success" id="contributeBtn">Add My Contribution</button>
                <button onclick="verifyContributions()" id="verifyBtn">Verify All Contributions</button>
                <button onclick="finalizeCeremony()" id="finalizeBtn" disabled>Finalize & Export Parameters</button>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label>Ceremony State (share with next participant):</label>
                <textarea id="ceremonyState" readonly onclick="this.select()"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="copyCeremonyState()">üìã Copy to Clipboard</button>
                    <button onclick="downloadCeremonyState()">üíæ Download State</button>
                </div>
            </div>
        </div>

        <!-- Import Ceremony -->
        <div class="phase" style="display: none;" id="importPhase">
            <h2>üì• Import Ceremony State</h2>
            <div class="input-group">
                <label>Paste ceremony state from previous participant:</label>
                <textarea id="importState" placeholder="Paste hex-encoded ceremony state here..."></textarea>
            </div>
            <div class="controls">
                <button onclick="importCeremonyState()">Import & Continue</button>
                <button onclick="cancelImport()">Cancel</button>
            </div>
        </div>

        <div class="log" id="log">
            <div class="log-entry log-info">Ready to start ceremony...</div>
        </div>
    </div>

    <script type="module">
        import init, { TrustedSetupCeremony, get_version } from './pkg/silent_threshold_encryption_wasm.js';

        let ceremony = null;

        async function initWasm() {
            await init();
            log('WASM module initialized (version: ' + get_version() + ')', 'success');
        }

        window.startCeremony = async function() {
            try {
                const maxDegree = parseInt(document.getElementById('maxDegree').value);

                log(`Starting new ceremony with max_degree=${maxDegree}...`, 'info');

                ceremony = new TrustedSetupCeremony(maxDegree);

                log('‚úì Ceremony initialized', 'success');
                log('‚úì First participant contribution added', 'success');

                showParticipantPhase();
                updateStats();
                updateCeremonyState();

            } catch (error) {
                log(`Error starting ceremony: ${error}`, 'error');
            }
        };

        window.loadCeremony = function() {
            document.getElementById('coordinatorPhase').style.display = 'none';
            document.getElementById('importPhase').style.display = 'block';
        };

        window.cancelImport = function() {
            document.getElementById('importPhase').style.display = 'none';
            document.getElementById('coordinatorPhase').style.display = 'block';
        };

        window.importCeremonyState = async function() {
            try {
                const stateHex = document.getElementById('importState').value.trim();

                if (!stateHex) {
                    log('Error: No ceremony state provided', 'error');
                    return;
                }

                log('Importing ceremony state...', 'info');

                // Convert hex to bytes
                const stateBytes = hexToBytes(stateHex);
                const maxDegree = parseInt(document.getElementById('maxDegree').value);

                ceremony = TrustedSetupCeremony.fromBytes(stateBytes, maxDegree);

                log('‚úì Ceremony state imported', 'success');

                document.getElementById('importPhase').style.display = 'none';
                showParticipantPhase();
                updateStats();
                updateCeremonyState();

            } catch (error) {
                log(`Error importing ceremony: ${error}`, 'error');
            }
        };

        window.addContribution = async function() {
            try {
                const numBefore = ceremony.numParticipants();

                log(`Adding contribution as participant #${numBefore}...`, 'info');
                log('‚è≥ Generating cryptographic randomness...', 'info');

                ceremony.contribute();

                const numAfter = ceremony.numParticipants();
                log(`‚úì Contribution added successfully (now ${numAfter} participants)`, 'success');
                log('‚ö†Ô∏è IMPORTANT: You should now destroy all local state!', 'warning');
                log('‚ö†Ô∏è Close this tab, clear cache, and restart browser', 'warning');

                updateStats();
                updateCeremonyState();

                document.getElementById('contributeBtn').disabled = true;

            } catch (error) {
                log(`Error adding contribution: ${error}`, 'error');
            }
        };

        window.verifyContributions = async function() {
            try {
                log('Verifying all contributions...', 'info');

                const isValid = ceremony.verifyAll();

                if (isValid) {
                    log('‚úì All contributions verified successfully!', 'success');
                    document.getElementById('finalizeBtn').disabled = false;
                } else {
                    log('‚úó Verification failed!', 'error');
                }

            } catch (error) {
                log(`Error verifying contributions: ${error}`, 'error');
            }
        };

        window.finalizeCeremony = async function() {
            try {
                log('Finalizing ceremony...', 'info');

                const paramsBytes = ceremony.finalize();

                log(`‚úì Ceremony finalized! Generated ${paramsBytes.length} bytes of parameters`, 'success');

                // Download parameters
                const blob = new Blob([paramsBytes], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'trusted_setup_params.bin';
                a.click();

                log('‚úì Parameters downloaded as trusted_setup_params.bin', 'success');
                log('üéâ Ceremony complete! These parameters can now be used for production.', 'success');

            } catch (error) {
                log(`Error finalizing ceremony: ${error}`, 'error');
            }
        };

        window.copyCeremonyState = function() {
            const stateText = document.getElementById('ceremonyState');
            stateText.select();
            document.execCommand('copy');
            log('‚úì Ceremony state copied to clipboard', 'success');
        };

        window.downloadCeremonyState = function() {
            const stateHex = document.getElementById('ceremonyState').value;
            const blob = new Blob([stateHex], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ceremony_state.txt';
            a.click();
            log('‚úì Ceremony state downloaded', 'success');
        };

        function showParticipantPhase() {
            document.getElementById('coordinatorPhase').style.display = 'none';
            document.getElementById('participantPhase').style.display = 'block';
        }

        function updateStats() {
            try {
                const statsJson = ceremony.getStats();
                const stats = JSON.parse(statsJson);

                document.getElementById('numParticipants').textContent = stats.num_participants;
                document.getElementById('statMaxDegree').textContent = stats.max_degree;
                document.getElementById('stateSize').textContent = formatBytes(stats.state_size_bytes);

            } catch (error) {
                log(`Error updating stats: ${error}`, 'error');
            }
        }

        function updateCeremonyState() {
            try {
                const stateBytes = ceremony.exportState();
                const stateHex = bytesToHex(stateBytes);
                document.getElementById('ceremonyState').value = stateHex;

            } catch (error) {
                log(`Error updating ceremony state: ${error}`, 'error');
            }
        }

        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.log = log;

        // Initialize WASM on page load
        initWasm().catch(error => {
            log(`Failed to initialize WASM: ${error}`, 'error');
        });
    </script>
</body>
</html>
